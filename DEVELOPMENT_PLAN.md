# UspMusicFinder Bot - –ü–ª–∞–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

**–û–±—â–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** 28 –¥–Ω–µ–π (4 –Ω–µ–¥–µ–ª–∏)
**–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è:** Agile / –ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
**–¶–µ–ª—å:** Production-ready –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π Telegram –±–æ—Ç

---

## üìÖ –û–±—â–∏–π –æ–±–∑–æ—Ä

| –ù–µ–¥–µ–ª—è | –§–∞–∑–∞ | –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|--------|------|----------------|-----------|
| **1** | MVP | –ë–∞–∑–æ–≤—ã–π –±–æ—Ç, –ø–æ–∏—Å–∫, —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ | –†–∞–±–æ—Ç–∞—é—â–∏–π –ø–æ–∏—Å–∫ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –º—É–∑—ã–∫–∏ |
| **2** | UI/UX | –ö–Ω–æ–ø–∫–∏, TOP, —É–ª—É—á—à–µ–Ω–∏—è | –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å |
| **3** | –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ | Inline —Ä–µ–∂–∏–º, –∞–ª—å—Ç. –∏—Å—Ç–æ—á–Ω–∏–∫–∏ | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª |
| **4** | Production | –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è, –¥–µ–ø–ª–æ–π, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ | Production –Ω–∞ VPS |

---

## üóìÔ∏è –ù–ï–î–ï–õ–Ø 1: MVP - –ë–∞–∑–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

**–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å —Ä–∞–±–æ—Ç–∞—é—â–∏–π –±–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –∏—â–µ—Ç –∏ —Å–∫–∞—á–∏–≤–∞–µ—Ç –º—É–∑—ã–∫—É

---

### –î–µ–Ω—å 1-2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –±–∞–∑–æ–≤—ã–π –±–æ—Ç

#### ‚úÖ –ó–∞–¥–∞—á–∏:

**1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è**
- [x] –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç —á–µ—Ä–µ–∑ `create-python-project.ps1`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `requirements.txt`
- [ ] –°–æ–∑–¥–∞—Ç—å `.env` —Ñ–∞–π–ª —Å —Ç–æ–∫–µ–Ω–æ–º
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: `pip install -r requirements.txt`

**2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞**
- [ ] –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:
  - `src/handlers/` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
  - `src/searchers/` - –ø–æ–∏—Å–∫–æ–≤—ã–µ –º–æ–¥—É–ª–∏
  - `src/downloaders/` - –∑–∞–≥—Ä—É–∑—á–∏–∫–∏
  - `src/utils/` - —É—Ç–∏–ª–∏—Ç—ã
  - `data/temp/` - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
  - `data/cache/` - –∫—ç—à
  - `logs/` - –ª–æ–≥–∏

**3. –ë–∞–∑–æ–≤—ã–µ —Ñ–∞–π–ª—ã**

`src/config.py`:
```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    BOT_TOKEN: str
    BOT_USERNAME: str = "UspMusicFinder_bot"

    TEMP_DIR: str = "./data/temp"
    CACHE_DIR: str = "./data/cache"
    LOGS_DIR: str = "./logs"

    MAX_FILE_SIZE: int = 52428800  # 50MB
    MAX_DURATION: int = 600  # 10 min

    LOG_LEVEL: str = "INFO"

    class Config:
        env_file = ".env"

settings = Settings()
```

`src/utils/logger.py`:
```python
import logging
from pathlib import Path
from src.config import settings

def setup_logger():
    Path(settings.LOGS_DIR).mkdir(parents=True, exist_ok=True)

    logging.basicConfig(
        level=settings.LOG_LEVEL,
        format='%(asctime)s | %(levelname)s | %(message)s',
        handlers=[
            logging.FileHandler(f"{settings.LOGS_DIR}/bot.log"),
            logging.StreamHandler()
        ]
    )

    return logging.getLogger(__name__)

logger = setup_logger()
```

`src/bot.py`:
```python
from aiogram import Bot, Dispatcher
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode
from src.config import settings

bot = Bot(
    token=settings.BOT_TOKEN,
    default=DefaultBotProperties(parse_mode=ParseMode.HTML)
)

dp = Dispatcher()
```

**4. Handlers - /start –∏ /help**

`src/handlers/start.py`:
```python
from aiogram import Router
from aiogram.filters import Command
from aiogram.types import Message

router = Router()

@router.message(Command("start"))
async def cmd_start(message: Message):
    await message.answer(
        "–ü—Ä–∏–≤–µ—Ç! –ß—Ç–æ–±—ã —è —Å–º–æ–≥ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –º—É–∑—ã–∫—É, –æ—Ç–ø—Ä–∞–≤—å –º–Ω–µ —á—Ç–æ-—Ç–æ –∏–∑ —ç—Ç–æ–≥–æ:\n\n"
        "‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏ –∏–ª–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è\n"
        "‚Ä¢ –°–ª–æ–≤–∞ –∏–∑ –ø–µ—Å–Ω–∏\n"
        "‚Ä¢ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n"
        "‚Ä¢ –í–∏–¥–µ–æ\n"
        "‚Ä¢ –ê—É–¥–∏–æ\n"
        "‚Ä¢ –í–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏–µ\n\n"
        "(–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –∏ –≤ —á–∞—Ç–∞—Ö —Ç–æ–∂–µ.)"
    )

@router.message(Command("help"))
async def cmd_help(message: Message):
    await message.answer(
        "üéµ <b>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:</b>\n\n"
        "1Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤—å –º–Ω–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏ –∏–ª–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è\n"
        "2Ô∏è‚É£ –í—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫ –∏–∑ —Å–ø–∏—Å–∫–∞ (–Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É 1-10)\n"
        "3Ô∏è‚É£ –ü–æ–ª—É—á–∏ –∞—É–¥–∏–æ —Ñ–∞–π–ª!\n\n"
        "üìä <b>–ö–æ–º–∞–Ω–¥—ã:</b>\n"
        "/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É\n"
        "/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n"
        "/top - –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–µ—Å–Ω–∏\n\n"
        "üí° <b>Inline —Ä–µ–∂–∏–º:</b>\n"
        "–í –ª—é–±–æ–º —á–∞—Ç–µ –≤–≤–µ–¥–∏: @UspMusicFinder_bot –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏"
    )
```

`src/main.py`:
```python
import asyncio
from src.bot import bot, dp
from src.handlers import start
from src.utils.logger import logger

async def main():
    # –ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ä–æ—É—Ç–µ—Ä—ã
    dp.include_router(start.router)

    # –£–¥–∞–ª–∏—Ç—å –≤–µ–±—Ö—É–∫ (–¥–ª—è polling)
    await bot.delete_webhook(drop_pending_updates=True)

    logger.info("Bot started successfully")
    logger.info(f"Bot @{(await bot.me()).username} is running...")

    # –ó–∞–ø—É—Å—Ç–∏—Ç—å polling
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
```

**5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç: `python src/main.py`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `/start` –∫–æ–º–∞–Ω–¥—É
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `/help` –∫–æ–º–∞–Ω–¥—É
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `logs/bot.log`

#### üì¶ Deliverables:

- ‚úÖ –†–∞–±–æ—Ç–∞—é—â–∏–π –±–∞–∑–æ–≤—ã–π –±–æ—Ç
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
- ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ .env
- ‚úÖ /start –∏ /help –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç

---

### –î–µ–Ω—å 3-4: YouTube Music –ø–æ–∏—Å–∫

#### ‚úÖ –ó–∞–¥–∞—á–∏:

**1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ yt-dlp**

```bash
pip install yt-dlp
```

**2. –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö**

`src/models.py`:
```python
from dataclasses import dataclass

@dataclass
class Track:
    id: str  # YouTube video ID
    title: str
    artist: str = "Unknown"
    duration: int = 0  # seconds
    url: str = ""

    @property
    def formatted_duration(self) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–∞–∫ MM:SS"""
        minutes = self.duration // 60
        seconds = self.duration % 60
        return f"{minutes}:{seconds:02d}"
```

**3. –ü–æ–∏—Å–∫–æ–≤–∏–∫ YouTube Music**

`src/searchers/youtube.py`:
```python
from typing import List
from yt_dlp import YoutubeDL
from src.models import Track
from src.utils.logger import logger

class YouTubeSearcher:
    def __init__(self):
        self.ydl_opts = {
            'quiet': True,
            'no_warnings': True,
            'extract_flat': True,
            'default_search': 'ytsearch10',
        }

    async def search(self, query: str) -> List[Track]:
        """–ü–æ–∏—Å–∫ —Ç—Ä–µ–∫–æ–≤ –Ω–∞ YouTube Music"""
        try:
            with YoutubeDL(self.ydl_opts) as ydl:
                logger.info(f"Searching YouTube for: {query}")
                result = ydl.extract_info(f"ytsearch10:{query}", download=False)

                if not result or 'entries' not in result:
                    logger.warning(f"No results for: {query}")
                    return []

                tracks = []
                for entry in result['entries']:
                    if not entry:
                        continue

                    # –ü–∞—Ä—Å–∏–Ω–≥ –Ω–∞–∑–≤–∞–Ω–∏—è (–æ–±—ã—á–Ω–æ "Artist - Title")
                    title = entry.get('title', 'Unknown')
                    artist = "Unknown"

                    if ' - ' in title:
                        parts = title.split(' - ', 1)
                        artist = parts[0].strip()
                        title = parts[1].strip()

                    track = Track(
                        id=entry['id'],
                        title=title,
                        artist=artist,
                        duration=entry.get('duration', 0),
                        url=f"https://youtube.com/watch?v={entry['id']}"
                    )
                    tracks.append(track)

                logger.info(f"Found {len(tracks)} tracks")
                return tracks[:10]

        except Exception as e:
            logger.error(f"Search error: {e}")
            return []

# Singleton instance
youtube_searcher = YouTubeSearcher()
```

**4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞**

`tests/test_youtube_search.py`:
```python
import pytest
from src.searchers.youtube import youtube_searcher

@pytest.mark.asyncio
async def test_search():
    tracks = await youtube_searcher.search("–í—Ä–µ–º—è –Ω–∞–∑–∞–¥")

    assert len(tracks) > 0
    assert tracks[0].id is not None
    assert tracks[0].title is not None
    print(f"\n‚úÖ Found {len(tracks)} tracks:")
    for i, track in enumerate(tracks, 1):
        print(f"{i}. {track.artist} - {track.title} ({track.formatted_duration})")

if __name__ == "__main__":
    import asyncio
    asyncio.run(test_search())
```

–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞:
```bash
python tests/test_youtube_search.py
```

**5. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –±–æ—Ç**

`src/handlers/search.py`:
```python
from aiogram import Router, F
from aiogram.types import Message
from src.searchers.youtube import youtube_searcher
from src.utils.logger import logger

router = Router()

@router.message(F.text)
async def text_search_handler(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤"""
    query = message.text

    # –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã
    if query.startswith('/'):
        return

    logger.info(f"User {message.from_user.id} searched: {query}")

    # –ü–æ–∫–∞–∑–∞—Ç—å "–ø–µ—á–∞—Ç–∞–µ—Ç..."
    await message.bot.send_chat_action(message.chat.id, "typing")

    # –ü–æ–∏—Å–∫
    tracks = await youtube_searcher.search(query)

    if not tracks:
        await message.answer("‚ùå –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å.")
        return

    # –§–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    text = f"<b>{query}</b>\n\n"
    for i, track in enumerate(tracks, 1):
        text += f"{i}. {track.title} {track.formatted_duration}\n"

    await message.answer(text)
```

–û–±–Ω–æ–≤–∏—Ç—å `src/main.py`:
```python
from src.handlers import start, search

async def main():
    dp.include_router(start.router)
    dp.include_router(search.router)  # –î–æ–±–∞–≤–∏—Ç—å
    # ...
```

#### üì¶ Deliverables:

- ‚úÖ YouTube Music –ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–æ 10 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ –Ω–∞–∑–≤–∞–Ω–∏—è –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
- ‚úÖ –ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç—Ä–µ–∫–æ–≤

---

### –î–µ–Ω—å 5-7: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –∞—É–¥–∏–æ

#### ‚úÖ –ó–∞–¥–∞—á–∏:

**1. Downloader –º–æ–¥—É–ª—å**

`src/downloaders/youtube_dl.py`:
```python
import os
from pathlib import Path
from yt_dlp import YoutubeDL
from src.config import settings
from src.utils.logger import logger

class YouTubeDownloader:
    def __init__(self):
        Path(settings.TEMP_DIR).mkdir(parents=True, exist_ok=True)

        self.ydl_opts = {
            'format': 'bestaudio/best',
            'outtmpl': f'{settings.TEMP_DIR}/%(id)s.%(ext)s',
            'quiet': True,
            'no_warnings': True,
            'postprocessors': [{
                'key': 'FFmpegExtractAudio',
                'preferredcodec': 'mp3',
                'preferredquality': '192',
            }],
        }

    async def download(self, video_id: str) -> str:
        """–°–∫–∞—á–∞—Ç—å —Ç—Ä–µ–∫ –∏ –≤–µ—Ä–Ω—É—Ç—å –ø—É—Ç—å –∫ MP3 —Ñ–∞–π–ª—É"""
        try:
            url = f"https://youtube.com/watch?v={video_id}"
            logger.info(f"Downloading: {video_id}")

            with YoutubeDL(self.ydl_opts) as ydl:
                info = ydl.extract_info(url, download=True)

                # –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É
                filename = ydl.prepare_filename(info)
                mp3_file = filename.rsplit('.', 1)[0] + '.mp3'

                # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä
                if os.path.exists(mp3_file):
                    file_size = os.path.getsize(mp3_file)
                    if file_size > settings.MAX_FILE_SIZE:
                        os.remove(mp3_file)
                        raise Exception(f"File too large: {file_size} bytes")

                    logger.info(f"Downloaded: {mp3_file} ({file_size} bytes)")
                    return mp3_file
                else:
                    raise Exception("MP3 file not created")

        except Exception as e:
            logger.error(f"Download error for {video_id}: {e}")
            raise

youtube_downloader = YouTubeDownloader()
```

**2. –ö—ç—à –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞**

`src/utils/cache.py`:
```python
from typing import Optional, List
from datetime import datetime, timedelta
from src.models import Track

class SimpleCache:
    """–ü—Ä–æ—Å—Ç–æ–π in-memory –∫—ç—à"""
    def __init__(self):
        self._cache = {}

    def set(self, key: str, value: List[Track], ttl: int = 600):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫—ç—à (ttl –≤ —Å–µ–∫—É–Ω–¥–∞—Ö)"""
        expire_at = datetime.now() + timedelta(seconds=ttl)
        self._cache[key] = {
            'data': value,
            'expire_at': expire_at
        }

    def get(self, key: str) -> Optional[List[Track]]:
        """–ü–æ–ª—É—á–∏—Ç—å –∏–∑ –∫—ç—à–∞"""
        if key not in self._cache:
            return None

        item = self._cache[key]

        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å—Ç–µ—á–µ–Ω–∏–µ
        if datetime.now() > item['expire_at']:
            del self._cache[key]
            return None

        return item['data']

    def clear(self):
        """–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à"""
        self._cache.clear()

cache = SimpleCache()
```

**3. Inline keyboard —Å –∫–Ω–æ–ø–∫–∞–º–∏**

`src/keyboards.py`:
```python
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from typing import List
from src.models import Track

def create_track_keyboard(tracks: List[Track]) -> InlineKeyboardMarkup:
    """–°–æ–∑–¥–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ 1-10"""
    buttons = []

    # –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞: 1-5
    row1 = [
        InlineKeyboardButton(text=str(i), callback_data=f"track:{i}")
        for i in range(1, min(6, len(tracks) + 1))
    ]

    # –í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞: 6-10
    row2 = [
        InlineKeyboardButton(text=str(i), callback_data=f"track:{i}")
        for i in range(6, min(11, len(tracks) + 1))
    ]

    if row1:
        buttons.append(row1)
    if row2:
        buttons.append(row2)

    return InlineKeyboardMarkup(inline_keyboard=buttons)
```

**4. –û–±–Ω–æ–≤–∏—Ç—å search handler**

`src/handlers/search.py`:
```python
from aiogram import Router, F
from aiogram.types import Message
from src.searchers.youtube import youtube_searcher
from src.keyboards import create_track_keyboard
from src.utils.cache import cache
from src.utils.logger import logger

router = Router()

@router.message(F.text)
async def text_search_handler(message: Message):
    query = message.text

    if query.startswith('/'):
        return

    logger.info(f"User {message.from_user.id} searched: {query}")

    await message.bot.send_chat_action(message.chat.id, "typing")

    tracks = await youtube_searcher.search(query)

    if not tracks:
        await message.answer("‚ùå –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å.")
        return

    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫—ç—à (10 –º–∏–Ω—É—Ç)
    cache_key = f"search:{message.from_user.id}"
    cache.set(cache_key, tracks, ttl=600)

    # –§–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫
    text = f"<b>{query}</b>\n\n"
    for i, track in enumerate(tracks, 1):
        text += f"{i}. {track.title} {track.formatted_duration}\n"

    # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
    keyboard = create_track_keyboard(tracks)

    await message.answer(text, reply_markup=keyboard)
```

**5. Callback handler –¥–ª—è –∫–Ω–æ–ø–æ–∫**

`src/handlers/callbacks.py`:
```python
from aiogram import Router, F
from aiogram.types import CallbackQuery
from aiogram.types import FSInputFile
import os
from src.downloaders.youtube_dl import youtube_downloader
from src.utils.cache import cache
from src.utils.logger import logger

router = Router()

@router.callback_query(F.data.startswith("track:"))
async def track_callback_handler(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ 1-10"""
    try:
        # –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–º–µ—Ä —Ç—Ä–µ–∫–∞
        track_num = int(callback.data.split(":")[1])

        # –ü–æ–ª—É—á–∏—Ç—å –∏–∑ –∫—ç—à–∞
        cache_key = f"search:{callback.from_user.id}"
        tracks = cache.get(cache_key)

        if not tracks:
            await callback.answer("‚ùå –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —É—Å—Ç–∞—Ä–µ–ª–∏. –ü–æ–∏—â–∏ –∑–∞–Ω–æ–≤–æ.", show_alert=True)
            return

        if track_num < 1 or track_num > len(tracks):
            await callback.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä —Ç—Ä–µ–∫–∞.", show_alert=True)
            return

        track = tracks[track_num - 1]

        # –ü–æ–∫–∞–∑–∞—Ç—å "–ó–∞–≥—Ä—É–∑–∫–∞..."
        await callback.message.edit_text("‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...")

        logger.info(f"User {callback.from_user.id} downloading: {track.id}")

        # –°–∫–∞—á–∞—Ç—å
        file_path = await youtube_downloader.download(track.id)

        # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞—É–¥–∏–æ
        audio_file = FSInputFile(file_path)

        await callback.message.answer_audio(
            audio=audio_file,
            performer=track.artist,
            title=track.title,
            duration=track.duration
        )

        # –£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ "–ó–∞–≥—Ä—É–∑–∫–∞..."
        await callback.message.delete()

        # –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª
        if os.path.exists(file_path):
            os.remove(file_path)

        await callback.answer("‚úÖ –ì–æ—Ç–æ–≤–æ!")

    except Exception as e:
        logger.error(f"Callback error: {e}")
        await callback.message.edit_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π —Ç—Ä–µ–∫.")
        await callback.answer()
```

–û–±–Ω–æ–≤–∏—Ç—å `src/main.py`:
```python
from src.handlers import start, search, callbacks

async def main():
    dp.include_router(start.router)
    dp.include_router(search.router)
    dp.include_router(callbacks.router)  # –î–æ–±–∞–≤–∏—Ç—å
    # ...
```

**6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
- [ ] –ü–æ–∏—Å–∫ —Ç—Ä–µ–∫–∞
- [ ] –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É 1-10
- [ ] –ü–æ–ª—É—á–∏—Ç—å MP3 —Ñ–∞–π–ª
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å, –Ω–∞–∑–≤–∞–Ω–∏–µ)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞

#### üì¶ Deliverables:

- ‚úÖ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ MP3 —á–µ—Ä–µ–∑ yt-dlp
- ‚úÖ Inline keyboard —Å –∫–Ω–æ–ø–∫–∞–º–∏
- ‚úÖ Callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –∞—É–¥–∏–æ –≤ Telegram
- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞

---

### ‚úÖ –ò—Ç–æ–≥ Week 1:

**MVP –≥–æ—Ç–æ–≤!** –ë–æ—Ç —É–º–µ–µ—Ç:
- ‚úÖ –ò—Å–∫–∞—Ç—å –º—É–∑—ã–∫—É –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ 10 —Ç—Ä–µ–∫–æ–≤
- ‚úÖ –°–∫–∞—á–∏–≤–∞—Ç—å MP3
- ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∞—É–¥–∏–æ —Ñ–∞–π–ª—ã

---

## üóìÔ∏è –ù–ï–î–ï–õ–Ø 2: UI/UX –∏ —É–ª—É—á—à–µ–Ω–∏—è

**–¶–µ–ª—å:** –£–ª—É—á—à–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ –¥–æ–±–∞–≤–∏—Ç—å TOP –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö

---

### –î–µ–Ω—å 8-10: –£–ª—É—á—à–µ–Ω–∏–µ UI

#### ‚úÖ –ó–∞–¥–∞—á–∏:

**1. –ö—Ä–∞—Å–∏–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è**

–û–±–Ω–æ–≤–∏—Ç—å `src/handlers/search.py`:
```python
# –§–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–∞—Å–∏–≤—ã–π —Å–ø–∏—Å–æ–∫
text = f"üéµ <b>{query}</b>\n\n"
for i, track in enumerate(tracks, 1):
    # –ò–∫–æ–Ω–∫–∏ –¥–ª—è –ø–µ—Ä–≤—ã—Ö 3 —Ç—Ä–µ–∫–æ–≤
    icon = "ü•á" if i == 1 else "ü•à" if i == 2 else "ü•â" if i == 3 else "‚ñ´Ô∏è"
    text += f"{icon} <b>{i}.</b> {track.title} <code>{track.formatted_duration}</code>\n"

text += "\nüëá –í—ã–±–µ—Ä–∏ –Ω–æ–º–µ—Ä —Ç—Ä–µ–∫–∞"
```

**2. Progress –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã**

```python
# –ü—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
await callback.message.edit_text(
    f"‚è≥ <b>–ó–∞–≥—Ä—É–∑–∫–∞...</b>\n\n"
    f"üéµ {track.title}\n"
    f"üë§ {track.artist}\n"
    f"‚è± {track.formatted_duration}"
)
```

**3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ - –∫—Ä–∞—Å–∏–≤–æ**

```python
# –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
await message.answer(
    "‚ùå <b>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</b>\n\n"
    "üí° –ü–æ–ø—Ä–æ–±—É–π:\n"
    "‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è\n"
    "‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫\n"
    "‚Ä¢ –ù–∞–ø–∏—Å–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏ –∏–ª–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è"
)

# –ï—Å–ª–∏ —Ñ–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π
await callback.message.edit_text(
    "‚ùå <b>–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π</b>\n\n"
    f"–†–∞–∑–º–µ—Ä: {file_size_mb} MB\n"
    f"–õ–∏–º–∏—Ç Telegram: 50 MB\n\n"
    "–ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π —Ç—Ä–µ–∫."
)
```

**4. Rate limiting**

`src/utils/rate_limiter.py`:
```python
from datetime import datetime, timedelta
from collections import defaultdict

class RateLimiter:
    def __init__(self, max_requests: int = 5, period: int = 60):
        self.max_requests = max_requests
        self.period = period  # seconds
        self.requests = defaultdict(list)

    def is_allowed(self, user_id: int) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Ä–∞–∑—Ä–µ—à–µ–Ω –ª–∏ –∑–∞–ø—Ä–æ—Å"""
        now = datetime.now()
        cutoff = now - timedelta(seconds=self.period)

        # –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã
        self.requests[user_id] = [
            req_time for req_time in self.requests[user_id]
            if req_time > cutoff
        ]

        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç
        if len(self.requests[user_id]) >= self.max_requests:
            return False

        # –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å
        self.requests[user_id].append(now)
        return True

    def time_until_allowed(self, user_id: int) -> int:
        """–°–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞"""
        if not self.requests[user_id]:
            return 0

        oldest = min(self.requests[user_id])
        wait_until = oldest + timedelta(seconds=self.period)
        wait_seconds = (wait_until - datetime.now()).total_seconds()

        return max(0, int(wait_seconds))

rate_limiter = RateLimiter(max_requests=5, period=60)
```

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ handlers:
```python
from src.utils.rate_limiter import rate_limiter

@router.message(F.text)
async def text_search_handler(message: Message):
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å rate limit
    if not rate_limiter.is_allowed(message.from_user.id):
        wait_time = rate_limiter.time_until_allowed(message.from_user.id)
        await message.answer(
            f"‚è≥ <b>–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</b>\n\n"
            f"–ü–æ–¥–æ–∂–¥–∏ {wait_time} —Å–µ–∫—É–Ω–¥."
        )
        return

    # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
```

**5. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**

`src/utils/stats.py`:
```python
from collections import defaultdict
from datetime import datetime

class Stats:
    def __init__(self):
        self.searches = defaultdict(int)  # {query: count}
        self.downloads = defaultdict(int)  # {track_id: count}
        self.users = set()

    def log_search(self, user_id: int, query: str):
        self.searches[query] += 1
        self.users.add(user_id)

    def log_download(self, user_id: int, track_id: str):
        self.downloads[track_id] += 1
        self.users.add(user_id)

    def get_popular_queries(self, limit: int = 10):
        """–¢–æ–ø –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤"""
        sorted_queries = sorted(
            self.searches.items(),
            key=lambda x: x[1],
            reverse=True
        )
        return sorted_queries[:limit]

    def get_total_users(self) -> int:
        return len(self.users)

stats = Stats()
```

#### üì¶ Deliverables:

- ‚úÖ –ö—Ä–∞—Å–∏–≤—ã–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ Progress –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ Rate limiting (5 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É)
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

---

### –î–µ–Ω—å 11-12: TOP –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –ø–µ—Å–µ–Ω

#### ‚úÖ –ó–∞–¥–∞—á–∏:

**1. –•–∞—Ä–¥–∫–æ–¥ TOP —Ç—Ä–µ–∫–æ–≤ (–≤—Ä–µ–º–µ–Ω–Ω–æ)**

`src/data/top_tracks.py`:
```python
TOP_TRACKS = {
    "ru": [  # –†–æ—Å—Å–∏—è
        {"query": "–í—Ä–µ–º—è –Ω–∞–∑–∞–¥ –°–ø–ª–∏–Ω", "artist": "–°–ø–ª–∏–Ω", "title": "–í—Ä–µ–º—è, –Ω–∞–∑–∞–¥!"},
        {"query": "–ì—Ä—É–ø–ø–∞ –∫—Ä–æ–≤–∏ –ö–∏–Ω–æ", "artist": "–ö–∏–Ω–æ", "title": "–ì—Ä—É–ø–ø–∞ –∫—Ä–æ–≤–∏"},
        {"query": "–ú–∞–º–∞ —è –≤ –î—É–±–∞–µ –§–∏–ª–∏–ø–ø –ö–∏—Ä–∫–æ—Ä–æ–≤", "artist": "–ö–∏—Ä–∫–æ—Ä–æ–≤", "title": "–ú–∞–º–∞ —è –≤ –î—É–±–∞–µ"},
        # ... –µ—â–µ 7 —Ç—Ä–µ–∫–æ–≤
    ],
    "en": [  # –ê–Ω–≥–ª–∏—è/–°–®–ê
        {"query": "Blinding Lights The Weeknd", "artist": "The Weeknd", "title": "Blinding Lights"},
        {"query": "Shape of You Ed Sheeran", "artist": "Ed Sheeran", "title": "Shape of You"},
        # ... –µ—â–µ 8 —Ç—Ä–µ–∫–æ–≤
    ],
    "uz": [  # –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω
        {"query": "–ñ–∏–≥–∞–Ω—Å–∫–∞—è Jakone Kiliana", "artist": "Jakone & Kiliana", "title": "–ñ–∏–≥–∞–Ω—Å–∫–∞—è"},
        # ... –µ—â–µ 9 —Ç—Ä–µ–∫–æ–≤
    ],
    # ... –¥—Ä—É–≥–∏–µ —Å—Ç—Ä–∞–Ω—ã
}
```

**2. TOP handler**

`src/handlers/top.py`:
```python
from aiogram import Router, F
from aiogram.filters import Command
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
from src.searchers.youtube import youtube_searcher
from src.data.top_tracks import TOP_TRACKS
from src.keyboards import create_track_keyboard
from src.utils.cache import cache

router = Router()

@router.message(Command("top"))
async def cmd_top(message: Message):
    """–ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±–æ—Ä —Å—Ç—Ä–∞–Ω"""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="üá∫üáø", callback_data="top:uz"),
            InlineKeyboardButton(text="üá∑üá∫", callback_data="top:ru"),
            InlineKeyboardButton(text="üá¨üáß", callback_data="top:en"),
            InlineKeyboardButton(text="üá∞üáø", callback_data="top:kz"),
            InlineKeyboardButton(text="üáπüá∑", callback_data="top:tr"),
            InlineKeyboardButton(text="üá¶üáø", callback_data="top:az"),
        ]
    ])

    await message.answer(
        "üéµ <b>TOP Popular Songs</b>\n\n"
        "Choose a language:",
        reply_markup=keyboard
    )

@router.callback_query(F.data.startswith("top:"))
async def top_country_callback(callback: CallbackQuery):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ø –¥–ª—è —Å—Ç—Ä–∞–Ω—ã"""
    country = callback.data.split(":")[1]

    if country not in TOP_TRACKS:
        await callback.answer("‚ùå –¢–æ–ø –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω—ã –ø–æ–∫–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω", show_alert=True)
        return

    await callback.message.edit_text("‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–ø–∞...")

    # –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–ø —Ç—Ä–µ–∫–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω—ã
    top_list = TOP_TRACKS[country]

    # –ü–æ–∏—Å–∫–∞—Ç—å –ø–µ—Ä–≤—ã–π —Ç—Ä–µ–∫ —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    tracks = []
    for item in top_list:
        results = await youtube_searcher.search(item["query"])
        if results:
            tracks.append(results[0])  # –ü–µ—Ä–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

    if not tracks:
        await callback.message.edit_text("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–ø–∞")
        return

    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫—ç—à
    cache_key = f"search:{callback.from_user.id}"
    cache.set(cache_key, tracks, ttl=3600)  # 1 —á–∞—Å

    # –§–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫
    text = "üéµ <b>TOP Popular Songs</b>\n\n"
    for i, track in enumerate(tracks, 1):
        text += f"{i}. {track.artist} ‚Äî {track.title}\n"

    text += "\nüëá –í—ã–±–µ—Ä–∏ –Ω–æ–º–µ—Ä —Ç—Ä–µ–∫–∞"

    keyboard = create_track_keyboard(tracks)

    await callback.message.edit_text(text, reply_markup=keyboard)
    await callback.answer()
```

–î–æ–±–∞–≤–∏—Ç—å –≤ `src/main.py`:
```python
from src.handlers import start, search, callbacks, top

async def main():
    dp.include_router(start.router)
    dp.include_router(search.router)
    dp.include_router(callbacks.router)
    dp.include_router(top.router)  # –î–æ–±–∞–≤–∏—Ç—å
```

**3. –ö—ç—à –¥–ª—è TOP**

TOP —Ç—Ä–µ–∫–∏ –∫—ç—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ 1 —á–∞—Å, —á—Ç–æ–±—ã –Ω–µ –¥–µ–ª–∞—Ç—å –ø–æ–∏—Å–∫ –∫–∞–∂–¥—ã–π —Ä–∞–∑.

#### üì¶ Deliverables:

- ‚úÖ `/top` –∫–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –í—ã–±–æ—Ä —Å—Ç—Ä–∞–Ω—ã (—Ñ–ª–∞–≥–∏)
- ‚úÖ –ü–æ–∫–∞–∑ —Ç–æ–ø 10 —Ç—Ä–µ–∫–æ–≤
- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 1 —á–∞—Å

---

### –î–µ–Ω—å 13-14: –ü–æ–ª–∏—Ä–æ–≤–∫–∞ –∏ —Ç–µ—Å—Ç—ã

#### ‚úÖ –ó–∞–¥–∞—á–∏:

**1. –û–±–Ω–æ–≤–∏—Ç—å /help**
```python
@router.message(Command("help"))
async def cmd_help(message: Message):
    await message.answer(
        "üéµ <b>UspMusicFinder Bot</b>\n\n"

        "<b>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:</b>\n"
        "1Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤—å –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏ –∏–ª–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è\n"
        "2Ô∏è‚É£ –í—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫ –∏–∑ —Å–ø–∏—Å–∫–∞ (1-10)\n"
        "3Ô∏è‚É£ –ü–æ–ª—É—á–∏ MP3 —Ñ–∞–π–ª!\n\n"

        "üìä <b>–ö–æ–º–∞–Ω–¥—ã:</b>\n"
        "/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É\n"
        "/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n"
        "/top - –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–µ—Å–Ω–∏\n"
        "/stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)\n\n"

        "üí° <b>Inline —Ä–µ–∂–∏–º:</b>\n"
        "–í –ª—é–±–æ–º —á–∞—Ç–µ: <code>@UspMusicFinder_bot –Ω–∞–∑–≤–∞–Ω–∏–µ</code>\n\n"

        "‚ö°Ô∏è <b>–õ–∏–º–∏—Ç—ã:</b>\n"
        "‚Ä¢ –ú–∞–∫—Å–∏–º—É–º 5 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É\n"
        "‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 50 MB\n"
        "‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 10 –º–∏–Ω—É—Ç"
    )
```

**2. Unit —Ç–µ—Å—Ç—ã**

`tests/test_searcher.py`:
```python
import pytest
from src.searchers.youtube import youtube_searcher

@pytest.mark.asyncio
async def test_youtube_search():
    tracks = await youtube_searcher.search("Test Song")
    assert isinstance(tracks, list)
    assert len(tracks) <= 10
```

`tests/test_downloader.py`:
```python
import pytest
import os
from src.downloaders.youtube_dl import youtube_downloader

@pytest.mark.asyncio
async def test_download():
    # –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ—Å—Ç–æ–≤—ã–π —Ç—Ä–µ–∫
    file_path = await youtube_downloader.download("dQw4w9WgXcQ")

    assert os.path.exists(file_path)
    assert file_path.endswith('.mp3')

    # –û—á–∏—Å—Ç–∫–∞
    os.remove(file_path)
```

**3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É–ª—É—á—à–∏—Ç—å**

–î–æ–±–∞–≤–∏—Ç—å –≤ –ª–æ–≥–∏ –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:
```python
logger.info(f"User {user_id} | Search: {query} | Results: {len(tracks)}")
logger.info(f"User {user_id} | Download: {track.id} | Title: {track.title}")
logger.error(f"Download failed | Track: {track_id} | Error: {str(e)}")
```

#### üì¶ Deliverables:

- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è /help –∫–æ–º–∞–Ω–¥–∞
- ‚úÖ Unit —Ç–µ—Å—Ç—ã
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ö–æ–¥ –æ—Ç—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–µ–Ω

---

### ‚úÖ –ò—Ç–æ–≥ Week 2:

**UI/UX –≥–æ—Ç–æ–≤!** –ë–æ—Ç –∏–º–µ–µ—Ç:
- ‚úÖ –ö—Ä–∞—Å–∏–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ Progress –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
- ‚úÖ Rate limiting
- ‚úÖ TOP –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –ø–µ—Å–µ–Ω
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

---

## üóìÔ∏è –ù–ï–î–ï–õ–Ø 3: Inline —Ä–µ–∂–∏–º –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è

**–¶–µ–ª—å:** –î–æ–±–∞–≤–∏—Ç—å inline —Ä–µ–∂–∏–º –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏

---

### –î–µ–Ω—å 15-17: Inline —Ä–µ–∂–∏–º

#### ‚úÖ –ó–∞–¥–∞—á–∏:

**1. –í–∫–ª—é—á–∏—Ç—å inline –≤ BotFather**

–í @BotFather:
```
/setinline
@UspMusicFinder_bot
–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏...
```

**2. Inline handler**

`src/handlers/inline.py`:
```python
from aiogram import Router
from aiogram.types import InlineQuery, InlineQueryResultAudio
from src.searchers.youtube import youtube_searcher
from src.utils.logger import logger

router = Router()

@router.inline_query()
async def inline_search_handler(inline_query: InlineQuery):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ inline –∑–∞–ø—Ä–æ—Å–æ–≤"""
    query = inline_query.query

    if not query or len(query) < 3:
        # –ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞
        await inline_query.answer([], cache_time=60)
        return

    logger.info(f"Inline query from {inline_query.from_user.id}: {query}")

    # –ü–æ–∏—Å–∫
    tracks = await youtube_searcher.search(query)

    if not tracks:
        await inline_query.answer([], cache_time=60)
        return

    # –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    results = []
    for i, track in enumerate(tracks[:10]):
        # Note: InlineQueryResultAudio —Ç—Ä–µ–±—É–µ—Ç –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ MP3
        # –î–ª—è YouTube —ç—Ç–æ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º InlineQueryResultArticle

        result = InlineQueryResultArticle(
            id=str(i),
            title=track.title,
            description=f"{track.artist} ‚Ä¢ {track.formatted_duration}",
            input_message_content=InputTextMessageContent(
                message_text=f"üéµ {track.artist} - {track.title}\n\n"
                             f"–ò—Å–ø–æ–ª—å–∑—É–π @UspMusicFinder_bot —á—Ç–æ–±—ã —Å–∫–∞—á–∞—Ç—å"
            ),
            thumbnail_url=f"https://img.youtube.com/vi/{track.id}/default.jpg"
        )
        results.append(result)

    await inline_query.answer(results, cache_time=300)
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –î–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ inline —Å –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∞—É–¥–∏–æ –Ω—É–∂–Ω—ã –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ MP3, –∫–æ—Ç–æ—Ä—ã—Ö —É YouTube –Ω–µ—Ç. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å webhook –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∞—É–¥–∏–æ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞.

**3. Webhook –ø–æ–¥—Ö–æ–¥ –¥–ª—è inline (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**

–ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç - –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å webhook –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å `chosen_inline_result`:

```python
@router.chosen_inline_result()
async def chosen_inline_handler(chosen: ChosenInlineResult):
    """–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç"""
    track_index = int(chosen.result_id)

    # –ü–æ–ª—É—á–∏—Ç—å —Ç—Ä–µ–∫ –∏–∑ –∫—ç—à–∞ –∏–ª–∏ –ø–µ—Ä–µ–∏—Å–∫–∞—Ç—å
    # –°–∫–∞—á–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ bot.send_audio()
```

#### üì¶ Deliverables:

- ‚úÖ Inline —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
- ‚úÖ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –û—Ç–ø—Ä–∞–≤–∫–∞ –∞—É–¥–∏–æ —á–µ—Ä–µ–∑ chosen_inline_result

---

### –î–µ–Ω—å 18-19: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

#### ‚úÖ –ó–∞–¥–∞—á–∏:

**1. iTunes API –ø–æ–∏—Å–∫**

`src/searchers/itunes.py`:
```python
import aiohttp
from typing import List
from src.models import Track

class iTunesSearcher:
    API_URL = "https://itunes.apple.com/search"

    async def search(self, query: str) -> List[Track]:
        """–ü–æ–∏—Å–∫ –≤ iTunes"""
        params = {
            'term': query,
            'media': 'music',
            'limit': 10
        }

        async with aiohttp.ClientSession() as session:
            async with session.get(self.API_URL, params=params) as resp:
                data = await resp.json()

                tracks = []
                for item in data.get('results', []):
                    track = Track(
                        id=str(item['trackId']),
                        title=item.get('trackName', 'Unknown'),
                        artist=item.get('artistName', 'Unknown'),
                        duration=int(item.get('trackTimeMillis', 0) / 1000),
                        url=item.get('previewUrl', '')  # 30 sec preview
                    )
                    tracks.append(track)

                return tracks

itunes_searcher = iTunesSearcher()
```

**2. Fallback –º–µ—Ö–∞–Ω–∏–∑–º**

```python
async def search_with_fallback(query: str) -> List[Track]:
    """–ü–æ–∏—Å–∫ —Å fallback –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏"""
    # –°–Ω–∞—á–∞–ª–∞ YouTube
    tracks = await youtube_searcher.search(query)

    if tracks:
        return tracks

    # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ - –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å iTunes
    tracks = await itunes_searcher.search(query)

    return tracks
```

#### üì¶ Deliverables:

- ‚úÖ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) iTunes API –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω
- ‚úÖ Fallback –º–µ—Ö–∞–Ω–∏–∑–º
- ‚úÖ –ù–µ—Å–∫–æ–ª—å–∫–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–æ–∏—Å–∫–∞

---

### –î–µ–Ω—å 20-21: –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

#### ‚úÖ –ó–∞–¥–∞—á–∏:

**1. –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**

–¢—Ä–µ–±—É–µ—Ç API –≤—Ä–æ–¥–µ AudD.io –∏–ª–∏ Shazam. –ü–ª–∞—Ç–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª.

**2. –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**

`src/utils/history.py`:
```python
from collections import defaultdict, deque
from typing import List

class SearchHistory:
    def __init__(self, max_size: int = 10):
        self.max_size = max_size
        self.history = defaultdict(lambda: deque(maxlen=max_size))

    def add(self, user_id: int, query: str):
        if query not in self.history[user_id]:
            self.history[user_id].append(query)

    def get(self, user_id: int) -> List[str]:
        return list(self.history[user_id])

history = SearchHistory()
```

`/history` –∫–æ–º–∞–Ω–¥–∞:
```python
@router.message(Command("history"))
async def cmd_history(message: Message):
    user_history = history.get(message.from_user.id)

    if not user_history:
        await message.answer("üì≠ –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞ –ø—É—Å—Ç–∞")
        return

    text = "üìú <b>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞:</b>\n\n"
    for i, query in enumerate(reversed(user_history), 1):
        text += f"{i}. {query}\n"

    await message.answer(text)
```

**3. /stats –∫–æ–º–∞–Ω–¥–∞ (–¥–ª—è –∞–¥–º–∏–Ω–∞)**

```python
@router.message(Command("stats"))
async def cmd_stats(message: Message):
    # –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞
    ADMIN_ID = 123456789  # –¢–≤–æ–π user_id

    if message.from_user.id != ADMIN_ID:
        return

    from src.utils.stats import stats

    popular = stats.get_popular_queries(limit=10)

    text = "üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞</b>\n\n"
    text += f"üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {stats.get_total_users()}\n\n"
    text += "<b>–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:</b>\n"
    for query, count in popular:
        text += f"‚Ä¢ {query}: {count}\n"

    await message.answer(text)
```

#### üì¶ Deliverables:

- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞
- ‚úÖ /stats –∫–æ–º–∞–Ω–¥–∞
- ‚úÖ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ

---

### ‚úÖ –ò—Ç–æ–≥ Week 3:

**–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª!** –ë–æ—Ç –∏–º–µ–µ—Ç:
- ‚úÖ Inline —Ä–µ–∂–∏–º
- ‚úÖ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

---

## üóìÔ∏è –ù–ï–î–ï–õ–Ø 4: Production Ready

**–¶–µ–ª—å:** –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –±–æ—Ç –∫ –¥–µ–ø–ª–æ—é –Ω–∞ VPS

---

### –î–µ–Ω—å 22-24: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

#### ‚úÖ –ó–∞–¥–∞—á–∏:

**1. Cleanup —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤**

`src/utils/cleanup.py`:
```python
import os
import time
from pathlib import Path
from src.config import settings
from src.utils.logger import logger

def cleanup_old_files(max_age_seconds: int = 3600):
    """–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ 1 —á–∞—Å–∞"""
    temp_dir = Path(settings.TEMP_DIR)

    if not temp_dir.exists():
        return

    now = time.time()
    deleted = 0

    for file_path in temp_dir.glob("*.mp3"):
        age = now - file_path.stat().st_mtime

        if age > max_age_seconds:
            file_path.unlink()
            deleted += 1

    if deleted > 0:
        logger.info(f"Cleaned up {deleted} old files")

# –ó–∞–ø—É—Å–∫–∞—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏
async def cleanup_task():
    """–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –æ—á–∏—Å—Ç–∫–∏"""
    while True:
        cleanup_old_files()
        await asyncio.sleep(3600)  # –ö–∞–∂–¥—ã–π —á–∞—Å
```

–î–æ–±–∞–≤–∏—Ç—å –≤ `src/main.py`:
```python
import asyncio
from src.utils.cleanup import cleanup_task

async def main():
    # ... –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ—É—Ç–µ—Ä–æ–≤

    # –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ñ–æ–Ω–æ–≤—É—é –æ—á–∏—Å—Ç–∫—É
    asyncio.create_task(cleanup_task())

    await dp.start_polling(bot)
```

**2. Redis –∫—ç—à (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**

–ï—Å–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis –≤–º–µ—Å—Ç–æ in-memory –∫—ç—à–∞:

```python
import redis.asyncio as redis

class RedisCache:
    def __init__(self):
        self.redis = redis.Redis(host='localhost', port=6379, decode_responses=True)

    async def set(self, key: str, value: str, ttl: int):
        await self.redis.setex(key, ttl, value)

    async def get(self, key: str) -> str:
        return await self.redis.get(key)
```

**3. SQLite –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏**

`src/database.py`:
```python
import aiosqlite
from pathlib import Path

DB_PATH = "data/database.db"

async def init_db():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    Path("data").mkdir(exist_ok=True)

    async with aiosqlite.connect(DB_PATH) as db:
        await db.execute("""
            CREATE TABLE IF NOT EXISTS search_stats (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                query TEXT NOT NULL,
                results_count INTEGER,
                timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
            )
        """)

        await db.execute("""
            CREATE TABLE IF NOT EXISTS download_stats (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                track_id TEXT NOT NULL,
                track_title TEXT,
                artist TEXT,
                timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
            )
        """)

        await db.commit()

async def log_search(user_id: int, query: str, results_count: int):
    async with aiosqlite.connect(DB_PATH) as db:
        await db.execute(
            "INSERT INTO search_stats (user_id, query, results_count) VALUES (?, ?, ?)",
            (user_id, query, results_count)
        )
        await db.commit()

async def log_download(user_id: int, track_id: str, track_title: str, artist: str):
    async with aiosqlite.connect(DB_PATH) as db:
        await db.execute(
            "INSERT INTO download_stats (user_id, track_id, track_title, artist) VALUES (?, ?, ?, ?)",
            (user_id, track_id, track_title, artist)
        )
        await db.commit()
```

#### üì¶ Deliverables:

- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤
- ‚úÖ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) Redis –∫—ç—à
- ‚úÖ SQLite –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

---

### –î–µ–Ω—å 25-26: Docker –∏ –¥–µ–ø–ª–æ–π

#### ‚úÖ –ó–∞–¥–∞—á–∏:

**1. Dockerfile**

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ffmpeg (–Ω—É–∂–µ–Ω –¥–ª—è yt-dlp)
RUN apt-get update && \
    apt-get install -y ffmpeg && \
    rm -rf /var/lib/apt/lists/*

# –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å requirements
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
COPY . .

# –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
RUN mkdir -p data/temp data/cache logs

CMD ["python", "src/main.py"]
```

**2. docker-compose.yml**

```yaml
version: '3.8'

services:
  bot:
    build: .
    restart: always
    env_file:
      - .env
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    networks:
      - bot-network

  redis:
    image: redis:7-alpine
    restart: always
    networks:
      - bot-network
    volumes:
      - redis-data:/data

networks:
  bot-network:
    driver: bridge

volumes:
  redis-data:
```

**3. –î–µ–ø–ª–æ–π –Ω–∞ VPS**

```bash
# –ù–∞ VPS
cd /opt
git clone <your-repo> usp-music-finder
cd usp-music-finder

# –°–æ–∑–¥–∞—Ç—å .env
nano .env
# –í—Å—Ç–∞–≤–∏—Ç—å BOT_TOKEN –∏ –¥—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

# –ó–∞–ø—É—Å—Ç–∏—Ç—å
docker-compose up -d

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker-compose logs -f bot
```

**4. Systemd service (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ Docker)**

`/etc/systemd/system/usp-music-bot.service`:
```ini
[Unit]
Description=UspMusicFinder Telegram Bot
After=network.target

[Service]
Type=simple
User=botuser
WorkingDirectory=/opt/usp-music-finder
ExecStart=/opt/usp-music-finder/.venv/bin/python src/main.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

–ó–∞–ø—É—Å–∫:
```bash
sudo systemctl enable usp-music-bot
sudo systemctl start usp-music-bot
sudo systemctl status usp-music-bot
```

#### üì¶ Deliverables:

- ‚úÖ Dockerfile
- ‚úÖ docker-compose.yml
- ‚úÖ –î–µ–ø–ª–æ–π –Ω–∞ VPS
- ‚úÖ Systemd service

---

### –î–µ–Ω—å 27-28: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–ª–∏—Ä–æ–≤–∫–∞

#### ‚úÖ –ó–∞–¥–∞—á–∏:

**1. Healthcheck endpoint (–¥–ª—è Docker)**

```python
from aiohttp import web

async def healthcheck(request):
    return web.Response(text="OK")

async def start_healthcheck_server():
    app = web.Application()
    app.router.add_get('/health', healthcheck)

    runner = web.AppRunner(app)
    await runner.setup()

    site = web.TCPSite(runner, '0.0.0.0', 8080)
    await site.start()

# –í main.py
async def main():
    # –ó–∞–ø—É—Å—Ç–∏—Ç—å healthcheck —Å–µ—Ä–≤–µ—Ä
    asyncio.create_task(start_healthcheck_server())

    # ... –æ—Å—Ç–∞–ª—å–Ω–æ–µ
```

–û–±–Ω–æ–≤–∏—Ç—å Dockerfile:
```dockerfile
EXPOSE 8080
HEALTHCHECK --interval=30s --timeout=3s \
  CMD curl -f http://localhost:8080/health || exit 1
```

**2. –õ–æ–≥–∏ - —Ä–æ—Ç–∞—Ü–∏—è**

```python
from logging.handlers import RotatingFileHandler

handler = RotatingFileHandler(
    f"{settings.LOGS_DIR}/bot.log",
    maxBytes=10*1024*1024,  # 10 MB
    backupCount=5
)
```

**3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É**

```python
ADMIN_ID = 123456789  # –¢–≤–æ–π user_id

async def notify_admin(text: str):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É"""
    try:
        await bot.send_message(ADMIN_ID, f"‚ö†Ô∏è {text}")
    except Exception:
        pass

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö
try:
    # ... –∫–æ–¥
except Exception as e:
    logger.critical(f"Critical error: {e}")
    await notify_admin(f"Critical error: {e}")
```

**4. Backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**

```bash
#!/bin/bash
# backup.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/opt/backups/usp-music-finder"

mkdir -p $BACKUP_DIR

# –ë—ç–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
cp /opt/usp-music-finder/data/database.db $BACKUP_DIR/database_$DATE.db

# –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
find $BACKUP_DIR -name "database_*.db" -mtime +30 -delete

echo "Backup completed: $DATE"
```

–î–æ–±–∞–≤–∏—Ç—å –≤ crontab:
```bash
0 3 * * * /opt/usp-music-finder/backup.sh
```

**5. –§–∏–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã**

- [ ] –ü–æ–∏—Å–∫ –º—É–∑—ã–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] TOP –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Inline —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Rate limiting —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –õ–æ–≥–∏ –ø–∏—à—É—Ç—Å—è
- [ ] Cleanup —Ñ–∞–π–ª–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ë–æ—Ç –ø–µ—Ä–µ–∂–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫

#### üì¶ Deliverables:

- ‚úÖ Healthcheck endpoint
- ‚úÖ –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É
- ‚úÖ Backup —Å–∫—Ä–∏–ø—Ç
- ‚úÖ –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

### ‚úÖ –ò—Ç–æ–≥ Week 4:

**Production Ready!** –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ:
- ‚úÖ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
- ‚úÖ –î–µ–ø–ª–æ–π –Ω–∞ VPS
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- ‚úÖ –õ–æ–≥–∏ –∏ backup
- ‚úÖ –í—Å–µ —Ñ–∏—á–∏ —Ä–∞–±–æ—Ç–∞—é—Ç

---

## üìä –§–∏–Ω–∞–ª—å–Ω—ã–π Checklist

### MVP —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
- [ ] –ü–æ–∏—Å–∫ –º—É–∑—ã–∫–∏ –ø–æ —Ç–µ–∫—Å—Ç—É (YouTube)
- [ ] Inline keyboard (–∫–Ω–æ–ø–∫–∏ 1-10)
- [ ] –°–∫–∞—á–∏–≤–∞–Ω–∏–µ MP3
- [ ] –û—Ç–ø—Ä–∞–≤–∫–∞ –∞—É–¥–∏–æ –≤ Telegram
- [ ] /start, /help –∫–æ–º–∞–Ω–¥—ã

### UI/UX
- [ ] –ö—Ä–∞—Å–∏–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- [ ] Progress –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- [ ] Rate limiting
- [ ] TOP –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –ø–µ—Å–µ–Ω

### –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
- [ ] Inline —Ä–µ–∂–∏–º
- [ ] –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- [ ] (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏

### Production
- [ ] Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
- [ ] –î–µ–ø–ª–æ–π –Ω–∞ VPS
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (healthcheck)
- [ ] Backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤

---

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

1. **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:** –ë–æ—Ç –Ω–∞—Ö–æ–¥–∏—Ç –∏ —Å–∫–∞—á–∏–≤–∞–µ—Ç 90%+ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤
2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∑–∞–Ω–∏–º–∞–µ—Ç < 30 —Å–µ–∫—É–Ω–¥
3. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** Uptime > 99%
4. **UX:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞ < 3 –∫–ª–∏–∫–∞

---

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- **aiogram docs:** https://docs.aiogram.dev/
- **yt-dlp docs:** https://github.com/yt-dlp/yt-dlp
- **Telegram Bot API:** https://core.telegram.org/bots/api

---

**–ì–æ—Ç–æ–≤ –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!** üöÄ

–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: [ACTIONS.md](ACTIONS.md) - –ü–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞.

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MusicFinder Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        /* Auth Screen */
        .auth-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .auth-box {
            background: rgba(255,255,255,0.05);
            padding: 40px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            width: 100%;
            max-width: 400px;
        }

        .auth-box h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #00d4ff;
        }

        .auth-box input {
            width: 100%;
            padding: 14px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 16px;
        }

        .auth-box button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .auth-box button:hover {
            transform: scale(1.02);
        }

        /* Main Layout */
        .app-container {
            display: none;
        }

        .header {
            background: rgba(255,255,255,0.05);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #00d4ff;
        }

        .logo span {
            color: #ff6b6b;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .last-update {
            color: rgba(255,255,255,0.5);
            font-size: 14px;
        }

        .logout-btn {
            background: rgba(255,107,107,0.2);
            border: 1px solid rgba(255,107,107,0.4);
            color: #ff6b6b;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        /* Sidebar */
        .main-layout {
            display: flex;
        }

        .sidebar {
            width: 220px;
            background: rgba(255,255,255,0.03);
            min-height: calc(100vh - 60px);
            border-right: 1px solid rgba(255,255,255,0.1);
            padding: 20px 0;
        }

        .nav-item {
            padding: 14px 24px;
            cursor: pointer;
            color: rgba(255,255,255,0.6);
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.05);
            color: #fff;
        }

        .nav-item.active {
            background: rgba(0,212,255,0.1);
            color: #00d4ff;
            border-left-color: #00d4ff;
        }

        .nav-item i {
            margin-right: 10px;
        }

        /* Content */
        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .page-title {
            font-size: 28px;
            margin-bottom: 25px;
            color: rgba(255,255,255,0.9);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-card .icon {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #00d4ff;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: rgba(255,255,255,0.5);
            font-size: 13px;
            text-transform: uppercase;
        }

        .stat-card .change {
            font-size: 12px;
            margin-top: 8px;
        }

        .stat-card .change.up { color: #00ff88; }
        .stat-card .change.down { color: #ff6b6b; }

        .stat-card.premium .value { color: #ffd700; }
        .stat-card.downloads .value { color: #00ff88; }
        .stat-card.revenue .value { color: #ff6b6b; }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .chart-card h3 {
            margin-bottom: 15px;
            color: rgba(255,255,255,0.8);
            font-size: 16px;
        }

        .chart-container {
            position: relative;
            height: 280px;
        }

        /* Tables */
        .table-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 25px;
        }

        .table-card h3 {
            margin-bottom: 15px;
            color: rgba(255,255,255,0.8);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .search-input {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            padding: 10px 15px;
            color: #fff;
            width: 250px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        th {
            color: rgba(255,255,255,0.5);
            font-weight: 500;
            font-size: 12px;
            text-transform: uppercase;
        }

        td {
            color: rgba(255,255,255,0.8);
        }

        tr:hover td {
            background: rgba(255,255,255,0.03);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .badge-premium {
            background: rgba(255,215,0,0.2);
            color: #ffd700;
        }

        .badge-free {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.5);
        }

        .badge-success {
            background: rgba(0,255,136,0.2);
            color: #00ff88;
        }

        .badge-error {
            background: rgba(255,107,107,0.2);
            color: #ff6b6b;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        .pagination button.active {
            background: #00d4ff;
            border-color: #00d4ff;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Config Form */
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .config-item {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .config-item label {
            display: block;
            color: rgba(255,255,255,0.6);
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .config-item input {
            width: 100%;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            padding: 10px;
            color: #fff;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: #fff;
        }

        .btn-danger {
            background: rgba(255,107,107,0.2);
            border: 1px solid rgba(255,107,107,0.4);
            color: #ff6b6b;
        }

        .btn-success {
            background: rgba(0,255,136,0.2);
            border: 1px solid rgba(0,255,136,0.4);
            color: #00ff88;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal {
            background: #1a1a2e;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #00d4ff;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* User Detail */
        .user-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .detail-section {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .detail-section h4 {
            margin-bottom: 15px;
            color: rgba(255,255,255,0.8);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: rgba(255,255,255,0.5);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: rgba(255,0,0,0.1);
            border: 1px solid rgba(255,0,0,0.3);
            padding: 20px;
            border-radius: 8px;
            color: #ff6b6b;
            text-align: center;
        }

        /* System Info */
        .system-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .system-card {
            background: rgba(255,255,255,0.05);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }

        .system-card .value {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .system-card .label {
            color: rgba(255,255,255,0.5);
        }

        .system-card.warning .value { color: #ffd700; }
        .system-card.danger .value { color: #ff6b6b; }
        .system-card.ok .value { color: #00ff88; }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-box">
            <h2>MusicFinder Admin</h2>
            <p style="color: rgba(255,255,255,0.6); text-align: center; margin-bottom: 20px; font-size: 14px;">
                Используй команду <code style="background: rgba(0,212,255,0.2); padding: 2px 6px; border-radius: 4px;">/web_admin</code> в боте для получения кода
            </p>
            <input type="text" id="codeInput" placeholder="Код авторизации из бота" autocomplete="off">
            <button onclick="loginWithCode()">Войти</button>
            <p id="authError" style="color: #ff6b6b; text-align: center; margin-top: 15px; display: none;"></p>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <div class="header">
            <div class="logo">Music<span>Finder</span> Admin</div>
            <div class="header-right">
                <div class="last-update" id="lastUpdate">Загрузка...</div>
                <button class="logout-btn" onclick="logout()">Выход</button>
            </div>
        </div>

        <div class="main-layout">
            <div class="sidebar">
                <div class="nav-item active" data-page="dashboard">Главная</div>
                <div class="nav-item" data-page="users">Пользователи</div>
                <div class="nav-item" data-page="payments">Платежи</div>
                <div class="nav-item" data-page="referrals">Рефералы</div>
                <div class="nav-item" data-page="api-keys">API Ключи</div>
                <div class="nav-item" data-page="config">Настройки</div>
                <div class="nav-item" data-page="system">Система</div>
            </div>

            <div class="content">
                <!-- Dashboard Page -->
                <div class="page active" id="page-dashboard">
                    <h1 class="page-title">Главная</h1>

                    <div class="stats-grid" id="statsGrid">
                            <div class="loading"><div class="spinner"></div>Загрузка...</div>
                    </div>

                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3>Рост пользователей (30 дней)</h3>
                            <div class="chart-container">
                                <canvas id="usersChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3>Скачивания (30 дней)</h3>
                            <div class="chart-container">
                                <canvas id="downloadsChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3>Активность по часам</h3>
                            <div class="chart-container">
                                <canvas id="hourlyChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3>Топ треков</h3>
                            <table id="topTracksTable">
                                <thead>
                                    <tr><th>#</th><th>Трек</th><th>Скачиваний</th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Users Page -->
                <div class="page" id="page-users">
                    <h1 class="page-title">Пользователи</h1>

                    <div class="table-card">
                        <div class="table-header">
                            <div>
                                <select id="userFilter" onchange="loadUsers(1)" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 10px; border-radius: 6px; color: #fff;">
                                    <option value="">Все пользователи</option>
                                    <option value="premium">Только премиум</option>
                                    <option value="free">Только бесплатные</option>
                                </select>
                            </div>
                            <input type="text" class="search-input" id="userSearch" placeholder="Поиск по имени или ID..." onkeyup="debounce(loadUsers, 500)(1)">
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Имя</th>
                                    <th>Статус</th>
                                    <th>Скачиваний</th>
                                    <th>Поисков</th>
                                    <th>Рефералов</th>
                                    <th>Регистрация</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                        <div class="pagination" id="usersPagination"></div>
                    </div>
                </div>

                <!-- Payments Page -->
                <div class="page" id="page-payments">
                    <h1 class="page-title">Платежи</h1>

                    <div class="stats-grid" id="paymentStats"></div>

                    <div class="chart-card" style="margin-bottom: 25px;">
                        <h3>Доход (30 дней)</h3>
                        <div class="chart-container">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>

                    <div class="table-card">
                        <h3>Последние платежи</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Пользователь</th>
                                    <th>Сумма</th>
                                    <th>Тип</th>
                                    <th>Дата</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsTableBody"></tbody>
                        </table>
                        <div class="pagination" id="paymentsPagination"></div>
                    </div>
                </div>

                <!-- Referrals Page -->
                <div class="page" id="page-referrals">
                    <h1 class="page-title">Рефералы</h1>

                    <div class="stats-grid" id="referralStats"></div>

                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3>Рефералы (30 дней)</h3>
                            <div class="chart-container">
                                <canvas id="referralsChart"></canvas>
                            </div>
                        </div>
                        <div class="table-card">
                            <h3>Топ рефереров</h3>
                            <table id="topReferrersTable">
                                <thead>
                                    <tr><th>#</th><th>Пользователь</th><th>Рефералов</th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- API Keys Page -->
                <div class="page" id="page-api-keys">
                    <h1 class="page-title">API Ключи</h1>

                    <div class="table-card">
                        <div class="table-header">
                            <h3>Выданные ключи</h3>
                            <button class="btn btn-primary" onclick="showCreateKeyModal()">+ Новый ключ</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Название</th>
                                    <th>Ключ</th>
                                    <th>Запросов</th>
                                    <th>Последний запрос</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="apiKeysTableBody"></tbody>
                        </table>
                    </div>

                    <div class="table-card" id="keyRequestsSection" style="display: none;">
                        <h3>История запросов: <span id="selectedKeyName"></span></h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Запрос</th>
                                    <th>Целевой чат</th>
                                    <th>Статус</th>
                                    <th>Дата</th>
                                </tr>
                            </thead>
                            <tbody id="keyRequestsTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Config Page -->
                <div class="page" id="page-config">
                    <h1 class="page-title">Настройки</h1>

                    <div class="table-card">
                        <div class="table-header">
                            <h3>Переменные окружения</h3>
                            <button class="btn btn-success" onclick="reloadBot()">Перезагрузить бота</button>
                        </div>
                        <div class="config-grid" id="configGrid"></div>
                    </div>
                </div>

                <!-- System Page -->
                <div class="page" id="page-system">
                    <h1 class="page-title">Система</h1>

                    <div class="system-grid" id="systemGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Detail Modal -->
    <div class="modal-overlay" id="userDetailModal">
        <div class="modal" style="max-width: 800px;">
            <h3>Пользователь: <span id="modalUserName"></span></h3>
            <div id="userDetailContent"></div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeModal('userDetailModal')">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Create Key Modal -->
    <div class="modal-overlay" id="createKeyModal">
        <div class="modal">
            <h3>Создать API ключ</h3>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; color: rgba(255,255,255,0.6);">Название ключа</label>
                <input type="text" id="newKeyName" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: #fff;">
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('createKeyModal')" style="background: rgba(255,255,255,0.1);">Отмена</button>
                <button class="btn btn-primary" onclick="createApiKey()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Premium Modal -->
    <div class="modal-overlay" id="premiumModal">
        <div class="modal">
            <h3>Управление премиумом</h3>
            <input type="hidden" id="premiumUserId">
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; color: rgba(255,255,255,0.6);">Дней</label>
                <input type="number" id="premiumDays" value="30" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: #fff;">
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('premiumModal')" style="background: rgba(255,255,255,0.1);">Отмена</button>
                <button class="btn btn-danger" onclick="removePremium()">Снять премиум</button>
                <button class="btn btn-success" onclick="grantPremium()">Выдать премиум</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let sessionToken = localStorage.getItem('session_token');
        let currentUser = JSON.parse(localStorage.getItem('current_user') || 'null');
        let charts = {};
        let currentPage = { users: 1, payments: 1 };

        // Debounce helper
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // API helper
        async function fetchAPI(endpoint, options = {}) {
            if (!sessionToken) throw new Error('Not authenticated');

            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${sessionToken}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });

            if (response.status === 401) {
                logout();
                throw new Error('Unauthorized');
            }

            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }

            return response.json();
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num?.toString() || '0';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleString('ru-RU');
        }

        // Auth with Telegram code
        async function loginWithCode() {
            const code = document.getElementById('codeInput').value.trim();
            if (!code) {
                document.getElementById('authError').textContent = 'Введите код авторизации';
                document.getElementById('authError').style.display = 'block';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/telegram`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Неверный или истёкший код');
                }

                const data = await response.json();
                sessionToken = data.session_token;
                currentUser = { user_id: data.user_id, username: data.username };

                localStorage.setItem('session_token', sessionToken);
                localStorage.setItem('current_user', JSON.stringify(currentUser));

                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                init();
            } catch (e) {
                document.getElementById('authError').textContent = e.message;
                document.getElementById('authError').style.display = 'block';
            }
        }

        async function logout() {
            try {
                if (sessionToken) {
                    await fetch(`${API_BASE}/auth/logout`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${sessionToken}` }
                    });
                }
            } catch (e) { /* ignore */ }

            localStorage.removeItem('session_token');
            localStorage.removeItem('current_user');
            sessionToken = null;
            currentUser = null;
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                item.classList.add('active');
                document.getElementById('page-' + item.dataset.page).classList.add('active');

                // Load page data
                switch(item.dataset.page) {
                    case 'users': loadUsers(1); break;
                    case 'payments': loadPaymentsPage(); break;
                    case 'referrals': loadReferralsPage(); break;
                    case 'api-keys': loadApiKeys(); break;
                    case 'config': loadConfig(); break;
                    case 'system': loadSystemInfo(); break;
                }
            });
        });

        // Modals
        function showModal(id) {
            document.getElementById(id).style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // Dashboard
        async function loadOverview() {
            try {
                const data = await fetchAPI('/stats/overview');

                const userChange = data.new_users_yesterday > 0
                    ? ((data.new_users_today - data.new_users_yesterday) / data.new_users_yesterday * 100).toFixed(0)
                    : 0;

                const downloadChange = data.downloads_yesterday > 0
                    ? ((data.downloads_today - data.downloads_yesterday) / data.downloads_yesterday * 100).toFixed(0)
                    : 0;

                document.getElementById('statsGrid').innerHTML = `
                    <div class="stat-card">
                        <div class="icon">Всего</div>
                        <div class="value">${formatNumber(data.total_users)}</div>
                        <div class="label">Всего пользователей</div>
                    </div>
                    <div class="stat-card premium">
                        <div class="icon">Премиум</div>
                        <div class="value">${formatNumber(data.premium_users)}</div>
                        <div class="label">Премиум пользователей</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon">Сегодня</div>
                        <div class="value">${formatNumber(data.new_users_today)}</div>
                        <div class="label">Новых сегодня</div>
                        <div class="change ${userChange >= 0 ? 'up' : 'down'}">${userChange >= 0 ? '+' : ''}${userChange}% vs вчера</div>
                    </div>
                    <div class="stat-card downloads">
                        <div class="icon">Скачиваний</div>
                        <div class="value">${formatNumber(data.total_downloads)}</div>
                        <div class="label">Всего скачиваний</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon">Сегодня</div>
                        <div class="value">${formatNumber(data.downloads_today)}</div>
                        <div class="label">Скачиваний сегодня</div>
                        <div class="change ${downloadChange >= 0 ? 'up' : 'down'}">${downloadChange >= 0 ? '+' : ''}${downloadChange}% vs вчера</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon">Активные</div>
                        <div class="value">${formatNumber(data.active_users_week)}</div>
                        <div class="label">Активных (7 дней)</div>
                    </div>
                    <div class="stat-card revenue">
                        <div class="icon">Доход</div>
                        <div class="value">${formatNumber(data.total_revenue)} XTR</div>
                        <div class="label">Всего дохода</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon">Рефералы</div>
                        <div class="value">${formatNumber(data.total_referrals)}</div>
                        <div class="label">Всего рефералов</div>
                    </div>
                `;

                document.getElementById('lastUpdate').textContent = 'Обновлено: ' + new Date().toLocaleString('ru-RU');
            } catch (e) {
                document.getElementById('statsGrid').innerHTML = `<div class="error">Ошибка загрузки: ${e.message}</div>`;
            }
        }

        async function loadUsersChart() {
            try {
                const data = await fetchAPI('/stats/users/growth?days=30');
                const ctx = document.getElementById('usersChart').getContext('2d');
                if (charts.users) charts.users.destroy();

                charts.users = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.date),
                        datasets: [{
                            label: 'Новые пользователи',
                            data: data.map(d => d.count),
                            borderColor: '#00d4ff',
                            backgroundColor: 'rgba(0, 212, 255, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'rgba(255,255,255,0.5)' } },
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'rgba(255,255,255,0.5)' } }
                        }
                    }
                });
            } catch (e) { console.error('Users chart error:', e); }
        }

        async function loadDownloadsChart() {
            try {
                const data = await fetchAPI('/stats/downloads/daily?days=30');
                const ctx = document.getElementById('downloadsChart').getContext('2d');
                if (charts.downloads) charts.downloads.destroy();

                charts.downloads = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.date),
                        datasets: [{
                            label: 'Скачивания',
                            data: data.map(d => d.count),
                            backgroundColor: 'rgba(0, 255, 136, 0.6)',
                            borderColor: '#00ff88',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'rgba(255,255,255,0.5)' } },
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'rgba(255,255,255,0.5)' } }
                        }
                    }
                });
            } catch (e) { console.error('Downloads chart error:', e); }
        }

        async function loadHourlyChart() {
            try {
                const data = await fetchAPI('/stats/hourly');
                const ctx = document.getElementById('hourlyChart').getContext('2d');
                if (charts.hourly) charts.hourly.destroy();

                const hourlyData = Array(24).fill(0);
                data.forEach(d => { hourlyData[d.hour] = d.count; });

                charts.hourly = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: 'Активность',
                            data: hourlyData,
                            backgroundColor: 'rgba(255, 107, 107, 0.6)',
                            borderColor: '#ff6b6b',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'rgba(255,255,255,0.5)' } },
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'rgba(255,255,255,0.5)' } }
                        }
                    }
                });
            } catch (e) { console.error('Hourly chart error:', e); }
        }

        async function loadTopTracks() {
            try {
                const data = await fetchAPI('/stats/top-tracks?limit=10');
                const tbody = document.querySelector('#topTracksTable tbody');
                tbody.innerHTML = data.map((track, i) => `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${track.artist || 'Unknown'} - ${track.title || 'Unknown'}</td>
                        <td>${formatNumber(track.downloads)}</td>
                    </tr>
                `).join('') || '<tr><td colspan="3">Нет данных</td></tr>';
            } catch (e) { console.error('Top tracks error:', e); }
        }

        // Users Page
        async function loadUsers(page = 1) {
            currentPage.users = page;
            const search = document.getElementById('userSearch')?.value || '';
            const filter = document.getElementById('userFilter')?.value || '';

            try {
                const data = await fetchAPI(`/stats/users/list?page=${page}&limit=50&search=${search}&filter_type=${filter}`);
                const tbody = document.getElementById('usersTableBody');

                tbody.innerHTML = data.users.map(user => `
                    <tr>
                        <td>${user.telegram_id}</td>
                        <td>${user.username || user.first_name || '-'}</td>
                        <td><span class="badge ${user.is_premium ? 'badge-premium' : 'badge-free'}">${user.is_premium ? 'Премиум' : 'Бесплатный'}</span></td>
                        <td>${user.total_downloads}</td>
                        <td>${user.searches}</td>
                        <td>${user.referral_count}</td>
                        <td>${formatDate(user.created_at)}</td>
                        <td>
                            <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="showUserDetail(${user.telegram_id})">Инфо</button>
                            <button class="btn btn-success" style="padding: 5px 10px; font-size: 12px;" onclick="showPremiumModal(${user.telegram_id})">Премиум</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="8">Нет пользователей</td></tr>';

                // Pagination
                const pagination = document.getElementById('usersPagination');
                let paginationHtml = '';
                for (let i = 1; i <= data.pages; i++) {
                    if (i === 1 || i === data.pages || (i >= page - 2 && i <= page + 2)) {
                        paginationHtml += `<button class="${i === page ? 'active' : ''}" onclick="loadUsers(${i})">${i}</button>`;
                    } else if (i === page - 3 || i === page + 3) {
                        paginationHtml += '<button disabled>...</button>';
                    }
                }
                pagination.innerHTML = paginationHtml;
            } catch (e) { console.error('Load users error:', e); }
        }

        async function showUserDetail(telegramId) {
            try {
                const data = await fetchAPI(`/stats/users/${telegramId}`);
                document.getElementById('modalUserName').textContent = data.user.username || data.user.first_name || telegramId;

                document.getElementById('userDetailContent').innerHTML = `
                    <div class="user-detail-grid">
                        <div class="detail-section">
                            <h4>Информация</h4>
                            <p><strong>ID:</strong> ${data.user.telegram_id}</p>
                            <p><strong>Username:</strong> ${data.user.username || '-'}</p>
                            <p><strong>Имя:</strong> ${data.user.first_name || '-'}</p>
                            <p><strong>Премиум:</strong> ${data.user.is_premium ? 'Да (до ' + formatDate(data.user.premium_until) + ')' : 'Нет'}</p>
                            <p><strong>Регистрация:</strong> ${formatDate(data.user.created_at)}</p>
                            <p><strong>Поисков:</strong> ${data.user.searches}</p>
                            <p><strong>Скачиваний сегодня:</strong> ${data.user.daily_downloads}/10</p>
                            <p><strong>Бонусных скачиваний:</strong> ${data.user.bonus_downloads}</p>
                        </div>
                        <div class="detail-section">
                            <h4>Последние скачивания (${data.downloads.length})</h4>
                            ${data.downloads.slice(0, 10).map(d => `<p>${d.artist} - ${d.title} <small>${formatDate(d.downloaded_at)}</small></p>`).join('') || '<p>Нет скачиваний</p>'}
                        </div>
                        <div class="detail-section">
                            <h4>Рефералы (${data.referrals.length})</h4>
                            ${data.referrals.slice(0, 10).map(r => `<p>${r.username || r.telegram_id} <small>${formatDate(r.created_at)}</small></p>`).join('') || '<p>Нет рефералов</p>'}
                        </div>
                        <div class="detail-section">
                            <h4>Платежи (${data.payments.length})</h4>
                            ${data.payments.map(p => `<p>${p.amount} ${p.currency} - ${p.payment_type} <small>${formatDate(p.created_at)}</small></p>`).join('') || '<p>Нет платежей</p>'}
                        </div>
                    </div>
                `;

                showModal('userDetailModal');
            } catch (e) { console.error('User detail error:', e); }
        }

        function showPremiumModal(userId) {
            document.getElementById('premiumUserId').value = userId;
            showModal('premiumModal');
        }

        async function grantPremium() {
            const userId = document.getElementById('premiumUserId').value;
            const days = document.getElementById('premiumDays').value;

            try {
                await fetchAPI('/users/set-premium', {
                    method: 'POST',
                    body: JSON.stringify({ telegram_id: parseInt(userId), is_premium: true, days: parseInt(days) })
                });
                closeModal('premiumModal');
                loadUsers(currentPage.users);
            } catch (e) { alert('Ошибка: ' + e.message); }
        }

        async function removePremium() {
            const userId = document.getElementById('premiumUserId').value;

            try {
                await fetchAPI('/users/set-premium', {
                    method: 'POST',
                    body: JSON.stringify({ telegram_id: parseInt(userId), is_premium: false })
                });
                closeModal('premiumModal');
                loadUsers(currentPage.users);
            } catch (e) { alert('Ошибка: ' + e.message); }
        }

        // Payments Page
        async function loadPaymentsPage() {
            try {
                const overview = await fetchAPI('/stats/overview');

                document.getElementById('paymentStats').innerHTML = `
                    <div class="stat-card revenue">
                        <div class="value">${formatNumber(overview.total_revenue)}</div>
                        <div class="label">Всего дохода (XTR)</div>
                    </div>
                    <div class="stat-card">
                        <div class="value">${formatNumber(overview.revenue_today)}</div>
                        <div class="label">Доход сегодня</div>
                    </div>
                    <div class="stat-card premium">
                        <div class="value">${overview.premium_users}</div>
                        <div class="label">Премиум пользователей</div>
                    </div>
                `;

                // Revenue chart
                const paymentsData = await fetchAPI('/stats/payments?days=30');
                const ctx = document.getElementById('revenueChart').getContext('2d');
                if (charts.revenue) charts.revenue.destroy();

                const dailyRevenue = {};
                paymentsData.forEach(p => {
                    if (!dailyRevenue[p.date]) dailyRevenue[p.date] = 0;
                    dailyRevenue[p.date] += p.total;
                });

                charts.revenue = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Object.keys(dailyRevenue),
                        datasets: [{
                            label: 'Доход',
                            data: Object.values(dailyRevenue),
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'rgba(255,255,255,0.5)' } },
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'rgba(255,255,255,0.5)' } }
                        }
                    }
                });

                // Payments list
                const list = await fetchAPI('/stats/payments/list?limit=50');
                document.getElementById('paymentsTableBody').innerHTML = list.payments.map(p => `
                    <tr>
                        <td>${p.username || p.first_name || p.user_id}</td>
                        <td>${p.amount} ${p.currency}</td>
                        <td><span class="badge badge-success">${p.payment_type}</span></td>
                        <td>${formatDate(p.created_at)}</td>
                    </tr>
                `).join('') || '<tr><td colspan="4">Нет платежей</td></tr>';
            } catch (e) { console.error('Payments error:', e); }
        }

        // Referrals Page
        async function loadReferralsPage() {
            try {
                const data = await fetchAPI('/stats/referrals');

                document.getElementById('referralStats').innerHTML = `
                    <div class="stat-card">
                        <div class="value">${data.total_referred}</div>
                        <div class="label">Всего приглашённых</div>
                    </div>
                    <div class="stat-card">
                        <div class="value">${data.total_referrers}</div>
                        <div class="label">Всего рефереров</div>
                    </div>
                `;

                // Chart
                const ctx = document.getElementById('referralsChart').getContext('2d');
                if (charts.referrals) charts.referrals.destroy();

                charts.referrals = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.daily_referrals.map(d => d.date),
                        datasets: [{
                            label: 'Рефералы',
                            data: data.daily_referrals.map(d => d.count),
                            backgroundColor: 'rgba(255, 215, 0, 0.6)',
                            borderColor: '#ffd700',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'rgba(255,255,255,0.5)' } },
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'rgba(255,255,255,0.5)' } }
                        }
                    }
                });

                // Top referrers
                document.querySelector('#topReferrersTable tbody').innerHTML = data.top_referrers.map((r, i) => `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${r.username || r.first_name || r.telegram_id}</td>
                        <td>${r.referral_count}</td>
                    </tr>
                `).join('') || '<tr><td colspan="3">Нет рефереров</td></tr>';
            } catch (e) { console.error('Referrals error:', e); }
        }

        // API Keys Page
        async function loadApiKeys() {
            try {
                const data = await fetchAPI('/keys/list');
                document.getElementById('apiKeysTableBody').innerHTML = data.keys.map(k => `
                    <tr>
                        <td>${k.name}</td>
                        <td><code>${k.key}</code></td>
                        <td>${k.requests}</td>
                        <td>${formatDate(k.last_request)}</td>
                        <td>
                            <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="showKeyRequests('${k.name}')">История</button>
                            <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteApiKey('${k.name}')">Удалить</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="5">Нет API ключей</td></tr>';
            } catch (e) { console.error('API keys error:', e); }
        }

        function showCreateKeyModal() {
            document.getElementById('newKeyName').value = '';
            showModal('createKeyModal');
        }

        async function createApiKey() {
            const name = document.getElementById('newKeyName').value;
            if (!name) { alert('Введите название ключа'); return; }

            try {
                const result = await fetchAPI('/keys/create', {
                    method: 'POST',
                    body: JSON.stringify({ name })
                });
                closeModal('createKeyModal');
                alert(`Ключ создан!\n\nНазвание: ${result.name}\nКлюч: ${result.key}\n\nСохраните этот ключ - он больше не будет показан!`);
                loadApiKeys();
            } catch (e) { alert('Ошибка: ' + e.message); }
        }

        async function deleteApiKey(name) {
            if (!confirm(`Удалить ключ "${name}"?`)) return;

            try {
                await fetchAPI(`/keys/${name}`, { method: 'DELETE' });
                loadApiKeys();
            } catch (e) { alert('Ошибка: ' + e.message); }
        }

        async function showKeyRequests(name) {
            try {
                const data = await fetchAPI(`/keys/${name}/requests`);
                document.getElementById('selectedKeyName').textContent = name;
                document.getElementById('keyRequestsTableBody').innerHTML = data.requests.map(r => `
                    <tr>
                        <td>${r.query || '-'}</td>
                        <td>${r.target_chat_id || '-'}</td>
                        <td><span class="badge ${r.success ? 'badge-success' : 'badge-error'}">${r.success ? 'OK' : r.error}</span></td>
                        <td>${formatDate(r.created_at)}</td>
                    </tr>
                `).join('') || '<tr><td colspan="4">Нет запросов</td></tr>';
                document.getElementById('keyRequestsSection').style.display = 'block';
            } catch (e) { console.error('Key requests error:', e); }
        }

        // Config Page
        async function loadConfig() {
            try {
                const data = await fetchAPI('/config');
                document.getElementById('configGrid').innerHTML = Object.entries(data.config).map(([key, value]) => `
                    <div class="config-item">
                        <label>${key}</label>
                        <input type="text" value="${value}" data-key="${key}" onchange="updateConfig('${key}', this.value)">
                    </div>
                `).join('');
            } catch (e) { console.error('Config error:', e); }
        }

        async function updateConfig(key, value) {
            try {
                await fetchAPI('/config/update', {
                    method: 'POST',
                    body: JSON.stringify({ key, value })
                });
            } catch (e) { alert('Ошибка: ' + e.message); }
        }

        function reloadBot() {
            alert('Перезагрузка бота через API не реализована. Перезапустите сервис вручную.');
        }

        // System Page
        async function loadSystemInfo() {
            try {
                const data = await fetchAPI('/system/info');

                const getClass = (percent) => {
                    if (percent > 80) return 'danger';
                    if (percent > 60) return 'warning';
                    return 'ok';
                };

                document.getElementById('systemGrid').innerHTML = `
                    <div class="system-card ${getClass(data.cpu_percent)}">
                        <div class="value">${data.cpu_percent}%</div>
                        <div class="label">Загрузка CPU</div>
                    </div>
                    <div class="system-card ${getClass(data.memory_percent)}">
                        <div class="value">${data.memory_percent}%</div>
                        <div class="label">Использование памяти</div>
                    </div>
                    <div class="system-card ${getClass(data.disk_percent)}">
                        <div class="value">${data.disk_percent}%</div>
                        <div class="label">Использование диска</div>
                    </div>
                `;
            } catch (e) { console.error('System info error:', e); }
        }

        // Initialize
        async function init() {
            await loadOverview();
            await Promise.all([
                loadUsersChart(),
                loadDownloadsChart(),
                loadHourlyChart(),
                loadTopTracks()
            ]);
        }

        // Check auth on load
        if (sessionToken) {
            fetchAPI('/stats/overview')
                .then(() => {
                    document.getElementById('authScreen').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'block';
                    init();
                })
                .catch(() => {
                    localStorage.removeItem('session_token');
                    localStorage.removeItem('current_user');
                    sessionToken = null;
                    currentUser = null;
                });
        }

        // Auto refresh
        setInterval(() => {
            if (sessionToken && document.getElementById('page-dashboard').classList.contains('active')) {
                loadOverview();
            }
        }, 60000);
    </script>
</body>
</html>
